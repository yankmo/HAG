# 配置文件迁移指南

## 概述

本项目已完成模块化重构，所有硬编码的配置已迁移到统一的配置管理系统中。

## 配置文件结构

```
config/
├── __init__.py          # 配置模块初始化
├── settings.py          # 配置类定义和管理器
└── config.yaml          # 默认配置文件
```

## 配置方式

### 1. YAML 配置文件 (推荐)

编辑 `config/config.yaml` 文件：

```yaml
neo4j:
  uri: "bolt://localhost:7687"
  username: "neo4j"
  password: "your_password"
  database: "neo4j"

ollama:
  base_url: "http://localhost:11434"
  default_model: "gemma3:4b"
  embedding_model: "bge-m3:latest"
  timeout: 30

weaviate:
  url: "http://localhost:8080"
  host: "localhost"
  port: 8080

app:
  debug: false
  log_level: "INFO"
  chunk_size: 1000
  chunk_overlap: 200
  max_results: 10
```

### 2. 环境变量

复制 `.env.example` 为 `.env` 并修改：

```bash
# Neo4j 配置
NEO4J_URI=bolt://localhost:7687
NEO4J_USERNAME=neo4j
NEO4J_PASSWORD=your_password

# Ollama 配置
OLLAMA_BASE_URL=http://localhost:11434
OLLAMA_DEFAULT_MODEL=gemma3:4b

# Weaviate 配置
WEAVIATE_URL=http://localhost:8080
```

### 3. JSON 配置文件

创建 `config/config.json`：

```json
{
  "neo4j": {
    "uri": "bolt://localhost:7687",
    "username": "neo4j",
    "password": "your_password",
    "database": "neo4j"
  },
  "ollama": {
    "base_url": "http://localhost:11434",
    "default_model": "gemma3:4b",
    "embedding_model": "bge-m3:latest",
    "timeout": 30
  },
  "weaviate": {
    "url": "http://localhost:8080",
    "host": "localhost",
    "port": 8080
  }
}
```

## 配置优先级

1. 环境变量 (最高优先级)
2. config.json 文件
3. config.yaml 文件
4. 默认值 (最低优先级)

## 使用方法

### 在代码中使用配置

```python
from config import get_config

# 获取配置实例
config = get_config()

# 使用 Neo4j 配置
neo4j_uri = config.neo4j.uri
neo4j_auth = config.neo4j.to_auth_tuple()

# 使用 Ollama 配置
ollama_url = config.ollama.base_url
ollama_model = config.ollama.default_model

# 使用 Weaviate 配置
weaviate_url = config.weaviate.url
```

### 重新加载配置

```python
from config import reload_config

# 重新加载配置（当配置文件发生变化时）
reload_config()
```

## 已迁移的文件

以下文件已完成配置迁移：

### 核心模块
- `src/knowledge/modular_rag_system.py`
- `src/knowledge/vector_storage.py`
- `src/knowledge/intent_recognition_neo4j.py`
- `src/core/rag.py`

### 应用程序
- `app_simple.py`
- `main.py`

### 脚本文件
- `scripts/clear_neo4j.py`
- `scripts/query_neo4j.py`

### 测试文件
- `test/neo4j.py`

## 迁移前后对比

### 迁移前 (硬编码)
```python
# 硬编码配置
graph = Graph('bolt://localhost:7687', auth=('neo4j', 'hrx274700'))
ollama_client = ollama.Client(host='http://localhost:11434', timeout=30)
vector_store = WeaviateVectorStore(url='http://localhost:8080')
```

### 迁移后 (配置文件)
```python
# 使用配置文件
from config import get_config

config = get_config()
graph = Graph(config.neo4j.uri, auth=config.neo4j.to_auth_tuple())
ollama_client = ollama.Client(host=config.ollama.base_url, timeout=config.ollama.timeout)
vector_store = WeaviateVectorStore()  # 自动使用配置
```

## 配置验证

运行以下命令验证配置：

```python
from config import get_config

config = get_config()

# 检查服务状态
print("Neo4j URI:", config.neo4j.uri)
print("Ollama URL:", config.ollama.base_url)
print("Weaviate URL:", config.weaviate.url)

# 获取服务状态 URL
print("服务状态检查 URL:")
print("Neo4j Browser:", config.get_neo4j_browser_url())
print("Ollama API:", config.get_ollama_api_url())
print("Weaviate:", config.get_weaviate_url())
```

## 注意事项

1. **密码安全**: 不要将包含真实密码的配置文件提交到版本控制系统
2. **环境隔离**: 不同环境（开发、测试、生产）使用不同的配置文件
3. **配置备份**: 重要配置文件应该备份
4. **权限控制**: 配置文件应该设置适当的文件权限

## 故障排除

### 配置文件未找到
```
ConfigError: 配置文件未找到
```
解决方案：确保 `config/config.yaml` 文件存在，或设置相应的环境变量。

### 服务连接失败
```
ConnectionError: 无法连接到 Neo4j/Ollama/Weaviate
```
解决方案：检查配置中的服务地址和端口是否正确，确保服务正在运行。

### 权限错误
```
AuthError: Neo4j 认证失败
```
解决方案：检查 Neo4j 用户名和密码配置是否正确。